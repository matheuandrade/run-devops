# ===============================================
# Build, Push e Deploy para AKS usando ACR
# ===============================================

trigger:
- main

resources:
- repo: self

variables:
  # ğŸ”¹ Registro e imagem
  dockerRegistryServiceConnection: 'shopping-aks-connection'   # ğŸ‘ˆ nome atualizado do service connection AKS
  imageRepository: 'shoppingapi'
  containerRegistry: 'matheuandrade.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'acr-secret'

  # ğŸ”¹ Agente padrÃ£o
  vmImageName: 'ubuntu-latest'

  # ğŸ”¹ Namespace usado no AKS
  kubernetesNamespace: 'default'

stages:
# ===============================================
# ğŸ—ï¸ Stage 1: Build e Push da imagem Docker
# ===============================================
- stage: Build
  displayName: 'Build & Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build & Push'
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: 'Build and Push image to ACR'
      inputs:
        command: 'buildAndPush'
        repository: '$(imageRepository)'
        dockerfile: '$(dockerfilePath)'
        containerRegistry: '$(dockerRegistryServiceConnection)'
        tags: |
          $(tag)

    # ğŸ“¦ Publica os manifests (diretÃ³rio aks/) como artefato
    - task: PublishPipelineArtifact@1
      displayName: 'Publish manifests artifact'
      inputs:
        targetPath: 'aks'
        artifact: 'aks'

# ===============================================
# ğŸš€ Stage 2: Deploy no AKS
# ===============================================
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build

  jobs:
  - deployment: Deploy
    displayName: 'Deploy to Kubernetes cluster'
    environment: 'shopping-aks'   # ğŸ‘ˆ nome do Environment no Azure DevOps
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          # ğŸ”¹ Passo 1: criar secret para o ACR
          - task: KubernetesManifest@0
            displayName: 'Create imagePullSecret'
            inputs:
              action: 'createSecret'
              secretName: '$(imagePullSecret)'
              namespace: '$(kubernetesNamespace)'
              dockerRegistryEndpoint: '$(dockerRegistryServiceConnection)'

          # ğŸ”¹ Passo 2: aplicar os manifests (deployment + service)
          - task: KubernetesManifest@0
            displayName: 'Deploy manifests to AKS'
            inputs:
              action: deploy
              namespace: '$(kubernetesNamespace)'
              manifests: |
                $(Pipeline.Workspace)/aks/shoppingapi-deployment.yml
                $(Pipeline.Workspace)/aks/shoppingapi-service.yml
              imagePullSecrets: |
                $(imagePullSecret)
              containers: |
                $(containerRegistry)/$(imageRepository):$(tag)
